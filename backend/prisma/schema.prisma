generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id            String              @id @default(uuid())
  name          String
  createdAt     DateTime            @default(now())
  auditLogs     AuditLog[]
  comments      Comment[]
  history       HistoryItem[]
  notifications Notification[]
  projects      Project[]
  teamMembers   ProjectTeamMember[]
  scores        ScoreEntry[]
  users         User[]
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  target     String
  actorId    String
  actorEmail String?
  timestamp  DateTime @default(now())
  metadata   Json?
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([timestamp])
}

model AuditOutbox {
  id         String   @id @default(uuid())
  action     String
  target     String
  actorId    String
  actorEmail String?
  tenantId   String
  metadata   Json?
  createdAt  DateTime @default(now())
}

model User {
  id               String               @id @default(uuid())
  name             String
  email            String               @unique
  password         String
  role             UserRole
  avatar           String?
  tenantId         String
  isActive         Boolean              @default(true)
  lastRevocationAt DateTime?
  comments         Comment[]
  notifications    Notification[]
  resetTokens      PasswordResetToken[]
  projectsDesigned Project[]            @relation("AssignedDesigner")
  projectsManaged  Project[]            @relation("AssignedDevManager")
  projectsQA       Project[]            @relation("AssignedQA")
  scores           ScoreEntry[]
  tenant           Tenant               @relation(fields: [tenantId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  tokenHash String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
}

model Project {
  id                   String              @id @default(uuid())
  name                 String
  clientName           String
  scope                String
  priority             Priority
  stage                ProjectStage
  overallDeadline      DateTime
  currentDeadline      DateTime?
  tenantId             String
  assignedDesignerId   String?
  assignedDevManagerId String?
  assignedQAId         String?
  designChecklist      Json[]
  devChecklist         Json[]
  qaChecklist          Json[]
  finalChecklist       Json[]
  isDelayed            Boolean             @default(false)
  qaFailCount          Int                 @default(0)
  createdAt            DateTime            @default(now())
  completedAt          DateTime?
  updatedAt            DateTime            @updatedAt
  version              Int                 @default(1)
  comments             Comment[]
  history              HistoryItem[]
  assignedDesigner     User?               @relation("AssignedDesigner", fields: [assignedDesignerId], references: [id])
  assignedDevManager   User?               @relation("AssignedDevManager", fields: [assignedDevManagerId], references: [id])
  assignedQA           User?               @relation("AssignedQA", fields: [assignedQAId], references: [id])
  tenant               Tenant              @relation(fields: [tenantId], references: [id])
  teamMembers          ProjectTeamMember[]
  scores               ScoreEntry[]

  @@index([tenantId])
  @@index([assignedDevManagerId])
  @@index([tenantId, createdAt])
}

model Comment {
  id        String   @id @default(uuid())
  text      String
  timestamp DateTime @default(now())
  userId    String
  projectId String
  tenantId  String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model HistoryItem {
  id                String       @id @default(uuid())
  stage             ProjectStage
  action            String
  timestamp         DateTime     @default(now())
  userId            String
  rejectionSnapshot Json?
  projectId         String
  tenantId          String
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant            Tenant       @relation(fields: [tenantId], references: [id])
}

model ScoreEntry {
  id        String   @id @default(uuid())
  date      DateTime @default(now())
  points    Int
  reason    String
  projectId String
  userId    String
  tenantId  String
  project   Project  @relation(fields: [projectId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, date])
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  timestamp DateTime @default(now())
  userId    String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, timestamp])
}

model ProjectTeamMember {
  id        String       @id @default(uuid())
  projectId String
  tenantId  String
  leadRole  TeamLeadRole
  name      String
  roleTitle String
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant    Tenant       @relation(fields: [tenantId], references: [id])

  @@index([projectId])
  @@index([tenantId])
  @@index([projectId, leadRole])
}

enum UserRole {
  ADMIN
  DESIGNER
  DEV_MANAGER
  QA_ENGINEER
}

enum ProjectStage {
  UPCOMING
  DESIGN
  DEVELOPMENT
  QA
  SEND_TO_CLIENT
  SENT_TO_CLIENT
  COMPLETED
  ADMIN_REVIEW
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TeamLeadRole {
  DESIGN
  DEV
  QA
}
